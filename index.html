<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HealthWise AI Agent</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=Fraunces:ital,opsz,wght@0,9..144,400;0,9..144,600;0,9..144,700;1,9..144,400&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0891b2;
            --primary-dark: #0e7490;
            --primary-light: #22d3ee;
            --accent: #059669;
            --accent-light: #34d399;
            --bg-gradient-start: #ecfeff;
            --bg-gradient-end: #f0fdfa;
            --surface: #ffffff;
            --surface-hover: #f8fafc;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-muted: #94a3b8;
            --border: #e2e8f0;
            --border-light: #f1f5f9;
            --error: #ef4444;
            --success: #10b981;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            --radius: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'DM Sans', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.6;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                radial-gradient(circle at 25% 25%, rgba(8, 145, 178, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 75% 75%, rgba(5, 150, 105, 0.03) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .app-container {
            position: relative;
            z-index: 1;
            max-width: 900px;
            margin: 0 auto;
            padding: 24px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            text-align: center;
            margin-bottom: 24px;
            animation: fadeInDown 0.6s ease-out;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .logo {
            display: inline-flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow);
        }

        .logo-icon svg {
            width: 28px;
            height: 28px;
            color: white;
        }

        .logo-text {
            font-family: 'Fraunces', serif;
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .tagline {
            color: var(--text-secondary);
            font-size: 0.95rem;
            font-weight: 400;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .chat-panel {
            background: var(--surface);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            border: 1px solid var(--border-light);
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 500px;
            max-height: calc(100vh - 180px);
            animation: fadeIn 0.6s ease-out 0.2s both;
        }

        .chat-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-header-title {
            font-family: 'Fraunces', serif;
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chat-header-title svg {
            color: var(--accent);
        }

        .clear-btn {
            padding: 8px 16px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background: var(--surface);
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .clear-btn:hover {
            border-color: var(--error);
            color: var(--error);
            background: rgba(239, 68, 68, 0.05);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .message {
            display: flex;
            gap: 12px;
            animation: messageIn 0.3s ease-out;
        }

        @keyframes messageIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .message.assistant .message-avatar {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            color: white;
        }

        .message.user .message-avatar {
            background: var(--border-light);
            color: var(--text-secondary);
        }

        .message-content {
            max-width: 75%;
            padding: 14px 18px;
            border-radius: var(--radius-lg);
            font-size: 0.9375rem;
            line-height: 1.7;
        }

        .message.assistant .message-content {
            background: var(--border-light);
            color: var(--text-primary);
            border-bottom-left-radius: 4px;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message-content p {
            margin-bottom: 12px;
        }

        .message-content p:last-child {
            margin-bottom: 0;
        }

        .message-content ul,
        .message-content ol {
            margin: 12px 0;
            padding-left: 24px;
        }

        .message-content li {
            margin-bottom: 6px;
        }

        .message-content strong {
            font-weight: 600;
        }

        .message-content code {
            background: rgba(0, 0, 0, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 0.875em;
        }

        .message.user .message-content code {
            background: rgba(255, 255, 255, 0.2);
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 8px 0;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-muted);
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .welcome-message {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .welcome-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, rgba(8, 145, 178, 0.1) 0%, rgba(5, 150, 105, 0.1) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
        }

        .welcome-icon svg {
            width: 40px;
            height: 40px;
            color: var(--primary);
        }

        .welcome-title {
            font-family: 'Fraunces', serif;
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .welcome-text {
            font-size: 0.9375rem;
            max-width: 400px;
            margin: 0 auto 24px;
        }

        .quick-prompts {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }

        .quick-prompt {
            padding: 10px 16px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 20px;
            font-family: inherit;
            font-size: 0.875rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .quick-prompt:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: rgba(8, 145, 178, 0.05);
        }

        .chat-input-container {
            padding: 20px 24px;
            border-top: 1px solid var(--border-light);
            background: var(--surface);
            border-radius: 0 0 var(--radius-lg) var(--radius-lg);
        }

        .chat-input-wrapper {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .chat-input {
            flex: 1;
            padding: 14px 18px;
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            font-family: inherit;
            font-size: 0.9375rem;
            color: var(--text-primary);
            background: var(--surface-hover);
            resize: none;
            min-height: 52px;
            max-height: 150px;
            transition: all 0.2s ease;
        }

        .chat-input:hover {
            border-color: var(--primary-light);
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(8, 145, 178, 0.1);
            background: var(--surface);
        }

        .chat-input::placeholder {
            color: var(--text-muted);
        }

        .send-btn {
            width: 52px;
            height: 52px;
            border: none;
            border-radius: var(--radius);
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .send-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .send-btn:active:not(:disabled) {
            transform: translateY(0);
        }

        .send-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .send-btn svg {
            width: 20px;
            height: 20px;
        }

        .input-footer {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-light);
        }

        .model-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-muted);
        }

        .model-selector svg {
            flex-shrink: 0;
        }

        .model-selector select {
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 6px 28px 6px 10px;
            font-family: inherit;
            font-size: 0.8125rem;
            color: var(--text-secondary);
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
            transition: all 0.2s ease;
        }

        .model-selector select:hover {
            border-color: var(--primary-light);
            color: var(--text-primary);
        }

        .model-selector select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(8, 145, 178, 0.1);
        }

        .input-footer {
            flex-direction: column;
            align-items: stretch;
            gap: 12px;
        }

        .api-key-section {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .api-key-input-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-muted);
        }

        .api-key-input-wrapper svg {
            flex-shrink: 0;
        }

        .api-key-input-wrapper input {
            flex: 1;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px 12px;
            font-family: inherit;
            font-size: 0.8125rem;
            color: var(--text-primary);
            transition: all 0.2s ease;
        }

        .api-key-input-wrapper input::placeholder {
            color: var(--text-muted);
        }

        .api-key-input-wrapper input:hover {
            border-color: var(--primary-light);
        }

        .api-key-input-wrapper input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(8, 145, 178, 0.1);
        }

        .connect-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border: none;
            border-radius: 8px;
            color: white;
            font-family: inherit;
            font-size: 0.8125rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .connect-btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        .connect-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .connect-btn.connected {
            background: var(--success);
        }

        .connection-status {
            font-size: 0.75rem;
            padding-left: 22px;
        }

        .connection-status.success {
            color: var(--success);
        }

        .connection-status.error {
            color: var(--error);
        }

        .connection-status.loading {
            color: var(--text-muted);
        }

        .footer {
            text-align: center;
            padding: 20px;
            color: var(--text-muted);
            font-size: 0.8125rem;
        }

        .footer a {
            color: var(--primary);
            text-decoration: none;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        @media (max-width: 600px) {
            .app-container {
                padding: 16px;
            }

            .chat-panel {
                max-height: none;
                min-height: 400px;
            }

            .message-content {
                max-width: 85%;
            }

            .quick-prompts {
                flex-direction: column;
            }

            .quick-prompt {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <div class="logo-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                    </svg>
                </div>
                <span class="logo-text">HealthWise AI</span>
            </div>
            <p class="tagline">Your intelligent healthcare information assistant</p>
        </header>

        <!-- Chat Panel -->
        <section class="chat-panel">
            <div class="chat-header">
                <h2 class="chat-header-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                    </svg>
                    Health Consultation
                </h2>
                <button class="clear-btn" onclick="clearChat()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 6h18"/>
                        <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                        <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
                    </svg>
                    Clear
                </button>
            </div>

            <div class="chat-messages" id="chat-messages">
                <div class="welcome-message">
                    <div class="welcome-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/>
                        </svg>
                    </div>
                    <h3 class="welcome-title">How can I help you today?</h3>
                    <p class="welcome-text">Ask me about symptoms, medications, wellness tips, or general health information.</p>
                    <div class="quick-prompts">
                        <button class="quick-prompt" onclick="sendQuickPrompt('What are common symptoms of seasonal allergies?')">
                            ü§ß Seasonal allergies
                        </button>
                        <button class="quick-prompt" onclick="sendQuickPrompt('What are the benefits of regular exercise?')">
                            üèÉ Exercise benefits
                        </button>
                        <button class="quick-prompt" onclick="sendQuickPrompt('How can I improve my sleep quality?')">
                            üò¥ Sleep quality tips
                        </button>
                        <button class="quick-prompt" onclick="sendQuickPrompt('What foods are good for heart health?')">
                            ‚ù§Ô∏è Heart-healthy foods
                        </button>
                    </div>
                </div>
            </div>

            <div class="chat-input-container">
                <div class="chat-input-wrapper">
                    <textarea 
                        class="chat-input" 
                        id="user-input" 
                        placeholder="Ask a health-related question..."
                        rows="1"
                        onkeydown="handleKeyDown(event)"
                        oninput="autoResize(this)"
                    ></textarea>
                    <button class="send-btn" id="send-btn" onclick="sendMessage()">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="m22 2-7 20-4-9-9-4Z"/>
                            <path d="M22 2 11 13"/>
                        </svg>
                    </button>
                </div>
                <div class="input-footer">
                    <div class="model-selector">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 2a4 4 0 0 0-4 4c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2 4 4 0 0 0-4-4Z"/>
                            <path d="M10 8v8"/>
                            <path d="M14 8v8"/>
                            <path d="M8 16a4 4 0 0 0 8 0"/>
                            <path d="M12 16v6"/>
                        </svg>
                        <select id="model-select" onchange="updateModel()">
                            <option value="meta-llama/Llama-3.1-8B-Instruct">Llama 3.1 8B</option>
                            <option value="HuggingFaceTB/SmolLM3-3B">SmolLM3 3B (Fast)</option>
                            <option value="mistralai/Mistral-7B-Instruct-v0.3">Mistral 7B</option>
                            <option value="Qwen/Qwen2.5-7B-Instruct">Qwen 2.5 7B</option>
                            <option value="deepseek-ai/DeepSeek-R1-Distill-Qwen-1.5B">DeepSeek R1 1.5B</option>
                            <option value="openai/gpt-oss-20b">GPT-OSS 20B</option>
                        </select>
                    </div>
                    <div class="api-key-section">
                        <div class="api-key-input-wrapper">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="m21 2-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0 3 3L22 7l-3-3m-3.5 3.5L19 4"/>
                            </svg>
                            <input 
                                type="password" 
                                id="api-key-input" 
                                placeholder="Enter HuggingFace API key (hf_...)"
                                onkeydown="handleApiKeyEnter(event)"
                            >
                            <button class="connect-btn" id="connect-btn" onclick="connectApiKey()">
                                Connect
                            </button>
                        </div>
                        <div class="connection-status" id="connection-status"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="footer">
            <p>HealthWise AI Agent ‚Ä¢ Powered by <a href="https://huggingface.co" target="_blank">Hugging Face</a></p>
        </footer>
    </div>

    <script>
        // State
        let conversationHistory = [];
        let isProcessing = false;
        let apiKey = localStorage.getItem('hf_api_key') || '';

        // Get selected model
        function getSelectedModel() {
            return document.getElementById('model-select').value;
        }

        // Update model (called when selection changes)
        function updateModel() {
            if (conversationHistory.length > 0) {
                conversationHistory = [];
            }
        }

        // Handle Enter key in API key input
        function handleApiKeyEnter(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                connectApiKey();
            }
        }

        // Connect with API key
        async function connectApiKey() {
            const input = document.getElementById('api-key-input');
            const btn = document.getElementById('connect-btn');
            const status = document.getElementById('connection-status');
            const key = input.value.trim();

            if (!key) {
                status.textContent = '‚ö†Ô∏è Please enter an API key';
                status.className = 'connection-status error';
                return;
            }

            if (!key.startsWith('hf_')) {
                status.textContent = '‚ö†Ô∏è Key should start with hf_';
                status.className = 'connection-status error';
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Connecting...';
            status.textContent = 'Testing connection...';
            status.className = 'connection-status loading';

            try {
                const response = await fetch('https://router.huggingface.co/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${key}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: getSelectedModel(),
                        messages: [{ role: 'user', content: 'Hi' }],
                        max_tokens: 5
                    })
                });

                if (response.ok) {
                    apiKey = key;
                    localStorage.setItem('hf_api_key', key);
                    status.textContent = '‚úì Connected successfully!';
                    status.className = 'connection-status success';
                    btn.textContent = 'Connected';
                    btn.className = 'connect-btn connected';
                    input.type = 'password';
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error?.message || `Error: ${response.status}`);
                }
            } catch (error) {
                status.textContent = `‚úó ${error.message}`;
                status.className = 'connection-status error';
                btn.textContent = 'Connect';
            } finally {
                btn.disabled = false;
            }
        }

        // Check for saved API key on load
        function checkSavedApiKey() {
            if (apiKey) {
                const input = document.getElementById('api-key-input');
                const btn = document.getElementById('connect-btn');
                const status = document.getElementById('connection-status');
                input.value = apiKey;
                btn.textContent = 'Connected';
                btn.className = 'connect-btn connected';
                status.textContent = '‚úì Using saved API key';
                status.className = 'connection-status success';
            }
        }

        // DOM Elements
        const chatMessages = document.getElementById('chat-messages');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');

        // Initialize on load
        document.addEventListener('DOMContentLoaded', checkSavedApiKey);

        // Healthcare system prompt
        const systemPrompt = `You are a knowledgeable healthcare information assistant. Your role is to provide accurate, helpful health information while always emphasizing:

1. You provide general health information only, NOT medical diagnoses or treatment recommendations
2. Users should always consult qualified healthcare professionals for medical advice
3. In case of emergencies, users should call emergency services immediately

Be informative, compassionate, and clear in your responses. When discussing symptoms, mention when it would be appropriate to seek professional medical attention.`;

        // Send message
        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message || isProcessing) return;

            // Check if API key is set
            if (!apiKey) {
                const status = document.getElementById('connection-status');
                status.textContent = '‚ö†Ô∏è Please enter your API key and connect first';
                status.className = 'connection-status error';
                document.getElementById('api-key-input').focus();
                return;
            }

            // Remove welcome message if present
            const welcomeEl = chatMessages.querySelector('.welcome-message');
            if (welcomeEl) welcomeEl.remove();

            // Add user message
            addMessage('user', message);
            userInput.value = '';
            autoResize(userInput);
            
            // Add typing indicator
            const typingId = addTypingIndicator();
            isProcessing = true;
            sendBtn.disabled = true;

            try {
                const messages = [
                    { role: 'system', content: systemPrompt },
                    ...conversationHistory,
                    { role: 'user', content: message }
                ];

                const response = await fetch('https://router.huggingface.co/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: getSelectedModel(),
                        messages: messages,
                        max_tokens: 1024,
                        temperature: 0.3,
                        stream: false
                    })
                });

                removeTypingIndicator(typingId);

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error?.message || `API Error: ${response.status}`);
                }

                const data = await response.json();
                let assistantMessage = '';

                if (data.choices && data.choices[0]) {
                    assistantMessage = data.choices[0].message?.content || data.choices[0].text || '';
                }

                if (assistantMessage) {
                    conversationHistory.push({ role: 'user', content: message });
                    conversationHistory.push({ role: 'assistant', content: assistantMessage });
                    
                    if (conversationHistory.length > 20) {
                        conversationHistory = conversationHistory.slice(-20);
                    }

                    addMessage('assistant', assistantMessage);
                } else {
                    throw new Error('No response received from the API');
                }

            } catch (error) {
                removeTypingIndicator(typingId);
                addMessage('assistant', `‚ö†Ô∏è **Error:** ${error.message}\n\nPlease check your API key and try again.`);
            } finally {
                isProcessing = false;
                sendBtn.disabled = false;
            }
        }

        // Add message to chat
        function addMessage(role, content) {
            const messageEl = document.createElement('div');
            messageEl.className = `message ${role}`;
            
            const avatarIcon = role === 'assistant' 
                ? `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>`
                : `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`;

            messageEl.innerHTML = `
                <div class="message-avatar">${avatarIcon}</div>
                <div class="message-content">${formatMessage(content)}</div>
            `;

            chatMessages.appendChild(messageEl);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Format message with basic markdown
        function formatMessage(text) {
            return text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/`(.*?)`/g, '<code>$1</code>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>')
                .replace(/^/, '<p>')
                .replace(/$/, '</p>');
        }

        // Add typing indicator
        function addTypingIndicator() {
            const id = 'typing-' + Date.now();
            const typingEl = document.createElement('div');
            typingEl.id = id;
            typingEl.className = 'message assistant';
            typingEl.innerHTML = `
                <div class="message-avatar">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
                </div>
                <div class="message-content">
                    <div class="typing-indicator">
                        <span></span><span></span><span></span>
                    </div>
                </div>
            `;
            chatMessages.appendChild(typingEl);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return id;
        }

        // Remove typing indicator
        function removeTypingIndicator(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        // Send quick prompt
        function sendQuickPrompt(prompt) {
            userInput.value = prompt;
            sendMessage();
        }

        // Clear chat
        function clearChat() {
            conversationHistory = [];
            chatMessages.innerHTML = `
                <div class="welcome-message">
                    <div class="welcome-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/>
                        </svg>
                    </div>
                    <h3 class="welcome-title">How can I help you today?</h3>
                    <p class="welcome-text">Ask me about symptoms, medications, wellness tips, or general health information.</p>
                    <div class="quick-prompts">
                        <button class="quick-prompt" onclick="sendQuickPrompt('What are common symptoms of seasonal allergies?')">
                            ü§ß Seasonal allergies
                        </button>
                        <button class="quick-prompt" onclick="sendQuickPrompt('What are the benefits of regular exercise?')">
                            üèÉ Exercise benefits
                        </button>
                        <button class="quick-prompt" onclick="sendQuickPrompt('How can I improve my sleep quality?')">
                            üò¥ Sleep quality tips
                        </button>
                        <button class="quick-prompt" onclick="sendQuickPrompt('What foods are good for heart health?')">
                            ‚ù§Ô∏è Heart-healthy foods
                        </button>
                    </div>
                </div>
            `;
        }

        // Handle keyboard events
        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // Auto-resize textarea
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 150) + 'px';
        }
    </script>
</body>
</html>
