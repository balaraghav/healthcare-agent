<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HealthWise AI Agent</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=Fraunces:ital,opsz,wght@0,9..144,400;0,9..144,600;0,9..144,700;1,9..144,400&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0891b2;
            --primary-dark: #0e7490;
            --primary-light: #22d3ee;
            --accent: #059669;
            --accent-light: #34d399;
            --bg-gradient-start: #ecfeff;
            --bg-gradient-end: #f0fdfa;
            --surface: #ffffff;
            --surface-hover: #f8fafc;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-muted: #94a3b8;
            --border: #e2e8f0;
            --border-light: #f1f5f9;
            --error: #ef4444;
            --success: #10b981;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            --radius: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'DM Sans', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.6;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                radial-gradient(circle at 25% 25%, rgba(8, 145, 178, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 75% 75%, rgba(5, 150, 105, 0.03) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .app-container {
            position: relative;
            z-index: 1;
            max-width: 900px;
            margin: 0 auto;
            padding: 24px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            text-align: center;
            margin-bottom: 16px;
            animation: fadeInDown 0.6s ease-out;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .logo {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow);
        }

        .logo-icon svg {
            width: 18px;
            height: 18px;
            color: white;
        }

        .logo-text {
            font-family: 'Fraunces', serif;
            font-size: 1.25rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .tagline {
            color: var(--text-secondary);
            font-size: 0.8125rem;
            font-weight: 400;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .chat-panel {
            background: var(--surface);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            border: 1px solid var(--border-light);
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 500px;
            max-height: calc(100vh - 180px);
            animation: fadeIn 0.6s ease-out 0.2s both;
        }

        .chat-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-header-title {
            font-family: 'Fraunces', serif;
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chat-header-title svg {
            color: var(--accent);
        }

        .clear-btn {
            padding: 8px 16px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background: var(--surface);
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .clear-btn:hover {
            border-color: var(--error);
            color: var(--error);
            background: rgba(239, 68, 68, 0.05);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .message {
            display: flex;
            gap: 12px;
            animation: messageIn 0.3s ease-out;
        }

        @keyframes messageIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .message.assistant .message-avatar {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            color: white;
        }

        .message.user .message-avatar {
            background: var(--border-light);
            color: var(--text-secondary);
        }

        .message-content {
            max-width: 75%;
            padding: 14px 18px;
            border-radius: var(--radius-lg);
            font-size: 0.9375rem;
            line-height: 1.7;
        }

        .message.assistant .message-content {
            background: var(--border-light);
            color: var(--text-primary);
            border-bottom-left-radius: 4px;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message-content p {
            margin-bottom: 12px;
        }

        .message-content p:last-child {
            margin-bottom: 0;
        }

        .message-content ul,
        .message-content ol {
            margin: 12px 0;
            padding-left: 24px;
        }

        .message-content li {
            margin-bottom: 6px;
        }

        .message-content strong {
            font-weight: 600;
        }

        .message-content code {
            background: rgba(0, 0, 0, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 0.875em;
        }

        .message.user .message-content code {
            background: rgba(255, 255, 255, 0.2);
        }

        .message-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: var(--radius);
            margin-bottom: 8px;
            border: 1px solid var(--border);
        }

        .message.user .message-image {
            border-color: rgba(255,255,255,0.3);
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 8px 0;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-muted);
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .welcome-message {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .welcome-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, rgba(8, 145, 178, 0.1) 0%, rgba(5, 150, 105, 0.1) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
        }

        .welcome-icon svg {
            width: 40px;
            height: 40px;
            color: var(--primary);
        }

        .welcome-title {
            font-family: 'Fraunces', serif;
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .welcome-text {
            font-size: 0.9375rem;
            max-width: 400px;
            margin: 0 auto 24px;
        }

        .quick-prompts {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }

        .quick-prompt {
            padding: 10px 16px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 20px;
            font-family: inherit;
            font-size: 0.875rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .quick-prompt:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: rgba(8, 145, 178, 0.05);
        }

        .chat-input-container {
            padding: 20px 24px;
            border-top: 1px solid var(--border-light);
            background: var(--surface);
            border-radius: 0 0 var(--radius-lg) var(--radius-lg);
        }

        .attached-image-preview {
            margin-bottom: 12px;
            position: relative;
            display: inline-block;
        }

        .attached-image-preview img {
            max-width: 200px;
            max-height: 150px;
            border-radius: var(--radius);
            border: 2px solid var(--primary);
            box-shadow: var(--shadow);
        }

        .remove-image-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--error);
            border: 2px solid white;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s ease;
        }

        .remove-image-btn:hover {
            transform: scale(1.1);
        }

        .chat-input-wrapper {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .input-actions {
            display: flex;
            gap: 4px;
            padding-bottom: 8px;
        }

        .action-btn {
            width: 36px;
            height: 36px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background: var(--surface);
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .action-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: rgba(8, 145, 178, 0.05);
        }

        .chat-input {
            flex: 1;
            padding: 14px 18px;
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            font-family: inherit;
            font-size: 0.9375rem;
            color: var(--text-primary);
            background: var(--surface-hover);
            resize: none;
            min-height: 52px;
            max-height: 150px;
            transition: all 0.2s ease;
        }

        .chat-input:hover {
            border-color: var(--primary-light);
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(8, 145, 178, 0.1);
            background: var(--surface);
        }

        .chat-input::placeholder {
            color: var(--text-muted);
        }

        .send-btn {
            width: 52px;
            height: 52px;
            border: none;
            border-radius: var(--radius);
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .send-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .send-btn:active:not(:disabled) {
            transform: translateY(0);
        }

        .send-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .send-btn svg {
            width: 20px;
            height: 20px;
        }

        .input-footer {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-light);
        }

        .model-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-muted);
        }

        .model-selector svg {
            flex-shrink: 0;
        }

        .model-selector select {
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 6px 28px 6px 10px;
            font-family: inherit;
            font-size: 0.8125rem;
            color: var(--text-secondary);
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
            transition: all 0.2s ease;
        }

        .model-selector select:hover {
            border-color: var(--primary-light);
            color: var(--text-primary);
        }

        .model-selector select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(8, 145, 178, 0.1);
        }

        .input-footer {
            flex-direction: column;
            align-items: stretch;
            gap: 12px;
        }

        .api-key-section {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .api-key-input-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-muted);
        }

        .api-key-input-wrapper svg {
            flex-shrink: 0;
        }

        .api-key-input-wrapper input {
            flex: 1;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px 12px;
            font-family: inherit;
            font-size: 0.8125rem;
            color: var(--text-primary);
            transition: all 0.2s ease;
        }

        .api-key-input-wrapper input::placeholder {
            color: var(--text-muted);
        }

        .api-key-input-wrapper input:hover {
            border-color: var(--primary-light);
        }

        .api-key-input-wrapper input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(8, 145, 178, 0.1);
        }

        .connect-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border: none;
            border-radius: 8px;
            color: white;
            font-family: inherit;
            font-size: 0.8125rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .connect-btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        .connect-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .connect-btn.connected {
            background: var(--success);
        }

        .connection-status {
            font-size: 0.75rem;
            padding-left: 22px;
        }

        .connection-status.success {
            color: var(--success);
        }

        .connection-status.error {
            color: var(--error);
        }

        .connection-status.loading {
            color: var(--text-muted);
        }

        .footer {
            text-align: center;
            padding: 20px;
            color: var(--text-muted);
            font-size: 0.8125rem;
        }

        .footer a {
            color: var(--primary);
            text-decoration: none;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        @media (max-width: 600px) {
            .app-container {
                padding: 16px;
            }

            .chat-panel {
                max-height: none;
                min-height: 400px;
            }

            .message-content {
                max-width: 85%;
            }

            .quick-prompts {
                flex-direction: column;
            }

            .quick-prompt {
                width: 100%;
            }
        }

        /* Appointment Panel Styles */
        .appointment-panel {
            background: var(--surface);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            border: 1px solid var(--border-light);
            margin-bottom: 24px;
            animation: fadeIn 0.6s ease-out;
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 500px;
            max-height: calc(100vh - 140px);
        }

        .appointment-header {
            padding: 12px 20px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-gradient-start);
        }

        .appointment-title {
            font-family: 'Fraunces', serif;
            font-size: 0.9375rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .appointment-title svg {
            color: var(--primary);
            width: 16px;
            height: 16px;
        }

        .refresh-btn {
            padding: 8px 16px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background: var(--surface);
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .refresh-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: rgba(8, 145, 178, 0.05);
        }

        .refresh-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .appointment-content {
            padding: 24px;
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .chat-message {
            display: flex;
            gap: 12px;
            animation: messageIn 0.3s ease-out;
        }

        .chat-message.assistant {
            flex-direction: row;
        }

        .chat-message-avatar {
            width: 36px;
            height: 36px;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            color: white;
        }

        .chat-message-avatar svg {
            width: 18px;
            height: 18px;
        }

        .chat-message-content {
            max-width: 85%;
            padding: 14px 18px;
            border-radius: var(--radius-lg);
            font-size: 0.9375rem;
            line-height: 1.7;
            background: var(--border-light);
            color: var(--text-primary);
            border-bottom-left-radius: 4px;
        }

        .chat-input-container {
            padding: 16px 20px;
            border-top: 1px solid var(--border-light);
            background: var(--surface);
            border-radius: 0 0 var(--radius-lg) var(--radius-lg);
        }

        .chat-input-wrapper {
            display: flex;
            gap: 8px;
            align-items: flex-end;
            margin-bottom: 12px;
        }

        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            font-family: inherit;
            font-size: 0.9375rem;
            color: var(--text-primary);
            background: var(--surface-hover);
            resize: none;
            min-height: 48px;
            max-height: 120px;
            transition: all 0.2s ease;
        }

        .chat-input:hover {
            border-color: var(--primary-light);
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(8, 145, 178, 0.1);
            background: var(--surface);
        }

        .chat-input::placeholder {
            color: var(--text-muted);
        }

        .send-btn {
            width: 48px;
            height: 48px;
            border: none;
            border-radius: var(--radius);
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .send-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .send-btn:active:not(:disabled) {
            transform: translateY(0);
        }

        .send-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .send-btn svg {
            width: 20px;
            height: 20px;
        }

        .model-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-muted);
            font-size: 0.8125rem;
        }

        .model-selector svg {
            flex-shrink: 0;
        }

        .model-selector select {
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 6px 28px 6px 10px;
            font-family: inherit;
            font-size: 0.8125rem;
            color: var(--text-secondary);
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
            transition: all 0.2s ease;
        }

        .model-selector select:hover {
            border-color: var(--primary-light);
            color: var(--text-primary);
        }

        .model-selector select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(8, 145, 178, 0.1);
        }

        .loading-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            margin: 0 auto 16px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .appointment-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--bg-gradient-start);
            padding: 12px;
            border-radius: var(--radius);
            border: 1px solid var(--border-light);
            text-align: center;
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 4px;
            line-height: 1.3;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-dark);
            font-family: 'Fraunces', serif;
        }

        @media (max-width: 600px) {
            .appointment-stats {
                gap: 8px;
            }

            .stat-card {
                padding: 10px 8px;
            }

            .stat-label {
                font-size: 0.7rem;
            }

            .stat-value {
                font-size: 1.25rem;
            }
        }

        .ai-suggestions {
            background: linear-gradient(135deg, rgba(8, 145, 178, 0.05) 0%, rgba(5, 150, 105, 0.05) 100%);
            border: 1px solid var(--primary-light);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-top: 20px;
        }

        .ai-suggestions-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
            color: var(--primary-dark);
            font-weight: 600;
        }

        .ai-suggestions-header svg {
            flex-shrink: 0;
        }

        .suggestion-item {
            background: var(--surface);
            padding: 14px 16px;
            border-radius: var(--radius);
            margin-bottom: 12px;
            border-left: 3px solid var(--accent);
            box-shadow: var(--shadow-sm);
        }

        .suggestion-item:last-child {
            margin-bottom: 0;
        }

        .suggestion-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .suggestion-text {
            color: var(--text-secondary);
            font-size: 0.9375rem;
            line-height: 1.6;
        }

        .error-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--error);
        }

        .error-state svg {
            width: 48px;
            height: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .appointments-list {
            margin-top: 20px;
        }

        .appointments-section-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .appointment-item {
            background: var(--surface);
            padding: 12px 16px;
            border-radius: var(--radius);
            margin-bottom: 8px;
            border: 1px solid var(--border-light);
            transition: all 0.2s ease;
        }

        .appointment-item:hover {
            border-color: var(--primary-light);
            box-shadow: var(--shadow-sm);
        }

        .appointment-time {
            font-size: 0.8125rem;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .appointment-details {
            color: var(--text-primary);
            font-size: 0.9375rem;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <div class="logo-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                    </svg>
                </div>
                <span class="logo-text">HealthWise AI</span>
            </div>
            <p class="tagline">Your intelligent healthcare information assistant</p>
        </header>

        <!-- Appointment AI Assistant -->
        <section class="appointment-panel" id="appointment-panel">
            <div class="appointment-header">
                <h2 class="appointment-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                        <line x1="16" y1="2" x2="16" y2="6"/>
                        <line x1="8" y1="2" x2="8" y2="6"/>
                        <line x1="3" y1="10" x2="21" y2="10"/>
                    </svg>
                    AI Appointment Insights
                </h2>
            </div>
            <div class="appointment-token-section" style="padding: 16px 24px; border-bottom: 1px solid var(--border-light); background: var(--bg-gradient-start);">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: var(--text-muted); flex-shrink: 0;">
                        <path d="m21 2-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0 3 3L22 7l-3-3m-3.5 3.5L19 4"/>
                    </svg>
                    <input 
                        type="password" 
                        id="appointment-token-input" 
                        placeholder="Access Token"
                        style="flex: 1; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 8px 12px; font-family: inherit; font-size: 0.8125rem; color: var(--text-primary);"
                        onchange="saveAppointmentToken()"
                    >
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: var(--text-muted); flex-shrink: 0;">
                        <path d="m21 2-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0 3 3L22 7l-3-3m-3.5 3.5L19 4"/>
                    </svg>
                    <input 
                        type="password" 
                        id="api-key-input" 
                        placeholder="HuggingFace API Key (hf_...)"
                        style="flex: 1; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 8px 12px; font-family: inherit; font-size: 0.8125rem; color: var(--text-primary);"
                        onkeydown="handleApiKeyEnter(event)"
                    >
                    <button class="connect-btn" id="connect-btn" onclick="connectApiKey()" style="padding: 8px 16px; white-space: nowrap;">
                        Connect
                    </button>
                </div>
                <div id="connection-status" style="font-size: 0.75rem; margin-top: 8px; padding-left: 22px;"></div>
            </div>
            <div class="appointment-content" id="appointment-content">
                <div class="chat-message assistant">
                    <div class="chat-message-avatar">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                        </svg>
                    </div>
                    <div class="chat-message-content">
                        <p style="margin: 0 0 8px 0; font-weight: 600; color: var(--primary-dark);">üëã Welcome to AI Appointment Insights!</p>
                        <p style="margin: 0; color: var(--text-secondary); font-size: 0.9375rem;">Enter your access token and HuggingFace API key above, then click "Load AI Insights" to analyze today's appointments and get personalized recommendations.</p>
                    </div>
                </div>
            </div>
            <div class="chat-input-container">
                <div class="chat-input-wrapper">
                    <textarea 
                        class="chat-input" 
                        id="chat-input" 
                        placeholder="Ask me to analyze your appointments..."
                        rows="1"
                        onkeydown="handleChatKeyDown(event)"
                        oninput="autoResizeChat(this)"
                    ></textarea>
                    <button class="send-btn" id="send-btn" onclick="loadAppointmentInsights()">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 2a4 4 0 0 0-4 4c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2 4 4 0 0 0-4-4Z"/>
                            <path d="M10 8v8"/>
                            <path d="M14 8v8"/>
                            <path d="M8 16a4 4 0 0 0 8 0"/>
                            <path d="M12 16v6"/>
                        </svg>
                    </button>
                </div>
                <div class="model-selector">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 2a4 4 0 0 0-4 4c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2 4 4 0 0 0-4-4Z"/>
                        <path d="M10 8v8"/>
                        <path d="M14 8v8"/>
                        <path d="M8 16a4 4 0 0 0 8 0"/>
                        <path d="M12 16v6"/>
                    </svg>
                    <select id="model-select" onchange="updateModel()">
                        <option value="meta-llama/Llama-3.2-11B-Vision-Instruct">Llama 3.2 Vision 11B üëÅÔ∏è</option>
                        <option value="meta-llama/Llama-3.1-8B-Instruct">Llama 3.1 8B</option>
                        <option value="HuggingFaceTB/SmolLM3-3B">SmolLM3 3B (Fast)</option>
                        <option value="Qwen/Qwen2.5-7B-Instruct">Qwen 2.5 7B</option>
                        <option value="mistralai/Mistral-7B-Instruct-v0.3">Mistral 7B</option>
                        <option value="openai/gpt-oss-20b">GPT-OSS 20B</option>
                    </select>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="footer">
            <p>HealthWise AI Agent ‚Ä¢ Powered by <a href="https://huggingface.co" target="_blank">Hugging Face</a></p>
        </footer>
    </div>

    <script>
        // State
        let conversationHistory = [];
        let isProcessing = false;
        let apiKey = localStorage.getItem('hf_api_key') || '';
        let attachedImage = null; // Store base64 image data
        let appointmentsData = { historical: [], today: [] };
        let appointmentAccessToken = localStorage.getItem('appointment_access_token') || '';
        
        // API Configuration
        const API_BASE_URL = 'https://yogeshinnovationdayproxyapp-hwa7a6atdqfwhuh5.eastus-01.azurewebsites.net';

        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            checkSavedApiKey();
            loadAppointmentToken();
            // Don't auto-refresh on load, require token first
        });
        
        // Load saved appointment token
        function loadAppointmentToken() {
            const input = document.getElementById('appointment-token-input');
            const status = document.getElementById('appointment-token-status');
            if (appointmentAccessToken && input) {
                input.value = appointmentAccessToken;
                status.textContent = '‚úì Token loaded';
                status.style.color = 'var(--success)';
            }
        }
        
        // Save appointment token
        function saveAppointmentToken() {
            const input = document.getElementById('appointment-token-input');
            const status = document.getElementById('appointment-token-status');
            appointmentAccessToken = input.value.trim();
            
            if (appointmentAccessToken) {
                localStorage.setItem('appointment_access_token', appointmentAccessToken);
                status.textContent = '‚úì Token saved';
                status.style.color = 'var(--success)';
            } else {
                localStorage.removeItem('appointment_access_token');
                status.textContent = '';
            }
        }
        
        // Helper function to extract patient name from FHIR participant array
        function getPatientName(participants) {
            if (!participants || !Array.isArray(participants)) return 'Patient';
            
            const patient = participants.find(p => 
                p.actor?.reference?.includes('Patient') || 
                p.actor?.type === 'Patient'
            );
            
            return patient?.actor?.display || 'Patient';
        }

        // Helper function to extract appointment type from FHIR appointment
        function getAppointmentType(appointment) {
            // Try description first (most common in this API)
            if (appointment.description) return appointment.description;
            
            // Try appointmentType or serviceType
            const typeData = appointment.appointmentType || appointment.serviceType;
            if (!typeData) return 'General Visit';
            
            // Handle array of types
            let type = Array.isArray(typeData) ? typeData[0] : typeData;
            
            // Handle CodeableConcept structure
            if (type.coding && Array.isArray(type.coding) && type.coding.length > 0) {
                return type.coding[0].display || type.coding[0].code || 'General Visit';
            }
            
            if (type.text) return type.text;
            
            return 'General Visit';
        }

        // Format markdown for simple inline rendering
        function formatMarkdown(text) {
            if (!text) return '';
            return text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/`(.*?)`/g, '<code>$1</code>');
        }

        // Fetch appointments from API
        async function fetchAppointments(startDate, endDate) {
            // Check if access token is provided
            if (!appointmentAccessToken) {
                throw new Error('Please enter an access token first');
            }
            
            const apiUrl = `${API_BASE_URL}/ehr/calendar/v2/events/query`;
            const params = new URLSearchParams({
                eventTypeCategory: 'Appointment',
                MinimumStartDateTimeUtc: startDate,
                MaximumStartDateTimeUtc: endDate
            });

            try {
                const response = await fetch(`${apiUrl}?${params}`, {
                    method: 'GET',
                    mode: 'cors',
                    headers: {
                        'Authorization': `Bearer ${appointmentAccessToken}`,
                        'Pf-Correlation-Id': 'd871b358-3e78-4e7c-80dc-45f6aa4e02dc',
                        'Pf-Private-Granted-Scopes': 'notification:manage_subscription_v1 patient:r_profile_v4 calendar:r_events_v2 GrantedScopes=notification:manage_subscription_v1 patient:r_profile_v4',
                        'Pf-Private-User-Id': 'EHR f58ee573-2feb-4366-a73f-5aa0c7eadeef',
                        'Pf-Private-Practice-Guid': '1850ba09-3010-4db5-bec6-3dcf92026c2e',
                        'Pf-Private-Provider-Guid': '8255693e-acb3-4b1b-aa0c-b12ccace99e6',
                        'Pf-Private-Client-Id': '33436d31-9dfb-42cc-af69-3c84d1740515',
                        'Pf-Private-Partner-Name': 'Name',
                        'Pf-Private-Partner-Guid': 'fd7ad0af-5aba-4f5b-933a-53fb4c9804a2'
                    }
                });
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }
                const data = await response.json();
                
                console.log('API Response:', data);
                
                // Extract FHIR Bundle from response (it's wrapped in FhirResource)
                const bundle = data.FhirResource || data;
                console.log('Bundle:', bundle);
                console.log('Resource Type:', bundle.resourceType);
                console.log('Has entry?', !!bundle.entry);
                console.log('Entry length:', bundle.entry?.length);
                
                // Extract appointments from FHIR Bundle
                if (bundle.resourceType === 'Bundle' && bundle.entry) {
                    console.log('FHIR Bundle received with', bundle.entry.length, 'entries');
                    const resources = bundle.entry.map(entry => entry.resource);
                    console.log('Resources extracted:', resources.length);
                    console.log('First resource:', resources[0]);
                    const appointments = resources.filter(r => r?.resourceType === 'Appointment');
                    console.log('Appointments after filter:', appointments.length);
                    return appointments;
                }
                
                // Fallback for non-bundle responses
                console.log('Non-bundle response received:', data);
                return Array.isArray(data) ? data : [];
            } catch (error) {
                console.error('Error fetching appointments:', error);
                throw error;
            }
        }

        // Generate AI suggestions based on historical and today's appointments
        async function generateAISuggestions(historicalAppointments, todayAppointments) {
            if (!apiKey) {
                throw new Error('API key not configured');
            }

            // Prepare data summary for AI - extract from FHIR structure
            const historicalSummary = historicalAppointments.map(apt => {
                const patientName = getPatientName(apt.participant);
                const appointmentType = getAppointmentType(apt);
                
                return {
                    date: apt.start,
                    patient: patientName,
                    type: appointmentType,
                    status: apt.status || 'unknown',
                    notes: apt.comment || ''
                };
            }).slice(0, 20); // Limit to prevent token overflow

            const todaySummary = todayAppointments.map(apt => {
                const patientName = getPatientName(apt.participant);
                const appointmentType = getAppointmentType(apt);
                
                return {
                    time: apt.start,
                    patient: patientName,
                    type: appointmentType,
                    status: apt.status || 'unknown',
                    notes: apt.comment || ''
                };
            });

            const prompt = `As a healthcare AI assistant, analyze the following appointment data and provide actionable insights for today's appointments.

HISTORICAL APPOINTMENTS (Last 14 days):
${JSON.stringify(historicalSummary, null, 2)}

TODAY'S APPOINTMENTS:
${JSON.stringify(todaySummary, null, 2)}

Based on patterns in historical appointments and today's schedule, provide:
1. Key preparation points for today's appointments
2. Patient-specific insights (if any recurring patients)
3. Time management recommendations
4. Potential areas requiring special attention

Format your response as a concise, actionable list of 3-5 specific suggestions for the healthcare provider.`;

            const messages = [
                {
                    role: 'system',
                    content: 'You are an expert healthcare assistant providing insights to help healthcare providers prepare for their daily appointments. Be concise, professional, and focus on actionable recommendations.'
                },
                {
                    role: 'user',
                    content: prompt
                }
            ];

            const response = await fetch('https://router.huggingface.co/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: getSelectedModel(),
                    messages: messages,
                    max_tokens: 800,
                    temperature: 0.7
                })
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.error?.message || `API Error: ${response.status}`);
            }

            const data = await response.json();
            return data.choices?.[0]?.message?.content || 'Unable to generate suggestions';
        }

        // Load appointment insights
        async function loadAppointmentInsights() {
            const contentEl = document.getElementById('appointment-content');
            const refreshBtn = document.querySelector('.refresh-btn');
            
            // Show loading state
            contentEl.innerHTML = `
                <div class="loading-state">
                    <div class="loading-spinner"></div>
                    <p>Loading appointment data and generating AI insights...</p>
                </div>
            `;
            
            if (refreshBtn) refreshBtn.disabled = true;

            try {
                // Fetch last 14 days (Jan 14-27, 2026)
                const historicalPromise = fetchAppointments(
                    '2026-01-14 00:00:00z',
                    '2026-01-27 23:59:59z'
                );

                // Fetch today's appointments (Jan 28, 2026)
                const todayPromise = fetchAppointments(
                    '2026-01-28 00:00:00z',
                    '2026-01-28 23:59:59z'
                );

                const [historical, today] = await Promise.all([historicalPromise, todayPromise]);
                
                // Data is already extracted from FHIR Bundle in fetchAppointments
                appointmentsData.historical = Array.isArray(historical) ? historical : [];
                appointmentsData.today = Array.isArray(today) ? today : [];

                console.log('Historical appointments:', appointmentsData.historical.length);
                console.log('Today appointments:', appointmentsData.today.length);
                console.log('Sample historical data:', appointmentsData.historical[0]);
                console.log('Sample today data:', appointmentsData.today[0]);

                // Generate AI suggestions
                let aiSuggestions = '';
                if (apiKey) {
                    try {
                        console.log('Generating AI suggestions...');
                        aiSuggestions = await generateAISuggestions(
                            appointmentsData.historical,
                            appointmentsData.today
                        );
                        console.log('AI suggestions generated:', aiSuggestions);
                    } catch (error) {
                        console.error('Error generating AI suggestions:', error);
                        aiSuggestions = `Unable to generate AI suggestions: ${error.message}`;
                    }
                } else {
                    console.log('No API key set');
                    aiSuggestions = 'Please connect your API key to enable AI-powered suggestions.';
                }

                // Display results
                displayAppointmentInsights(appointmentsData, aiSuggestions);

            } catch (error) {
                const errorMessage = error.message.includes('Failed to fetch') || error.name === 'TypeError'
                    ? 'CORS Error: The server needs to allow cross-origin requests from this website. Please contact the API administrator to enable CORS for this domain.'
                    : error.message;
                    
                contentEl.innerHTML = `
                    <div class="error-state">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="12" y1="8" x2="12" y2="12"/>
                            <line x1="12" y1="16" x2="12.01" y2="16"/>
                        </svg>
                        <p><strong>Error loading appointments</strong></p>
                        <p>${errorMessage}</p>
                        <p style="font-size: 0.875rem; margin-top: 12px; color: var(--text-muted);">API Endpoint: ${API_BASE_URL}</p>
                    </div>
                `;
            } finally {
                if (refreshBtn) refreshBtn.disabled = false;
            }
        }

        // Display appointment insights
        function displayAppointmentInsights(data, aiSuggestions) {
            const contentEl = document.getElementById('appointment-content');
            
            const todayCount = data.today.length;
            const historicalCount = data.historical.length;

            // Parse AI suggestions into structured format
            const suggestions = parseAISuggestions(aiSuggestions);

            // Build chat-style messages
            let messagesHtml = '';
            
            // Stats message
            messagesHtml += `
                <div class="chat-message assistant">
                    <div class="chat-message-avatar">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                        </svg>
                    </div>
                    <div class="chat-message-content">
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 12px;">
                            <div style="text-align: center; padding: 8px; background: rgba(8, 145, 178, 0.08); border-radius: 8px;">
                                <div style="font-size: 1.25rem; font-weight: 700; color: var(--primary-dark); font-family: 'Fraunces', serif;">${todayCount}</div>
                                <div style="font-size: 0.7rem; color: var(--text-muted);">Today</div>
                            </div>
                            <div style="text-align: center; padding: 8px; background: rgba(8, 145, 178, 0.08); border-radius: 8px;">
                                <div style="font-size: 1.25rem; font-weight: 700; color: var(--primary-dark); font-family: 'Fraunces', serif;">${historicalCount}</div>
                                <div style="font-size: 0.7rem; color: var(--text-muted);">Last 14 Days</div>
                            </div>
                            <div style="text-align: center; padding: 8px; background: rgba(8, 145, 178, 0.08); border-radius: 8px;">
                                <div style="font-size: 1.25rem; font-weight: 700; color: var(--primary-dark); font-family: 'Fraunces', serif;">${(historicalCount / 14).toFixed(1)}</div>
                                <div style="font-size: 0.7rem; color: var(--text-muted);">Avg/Day</div>
                            </div>
                        </div>
                        <p style="margin: 0; color: var(--text-secondary); font-size: 0.9375rem;">I've analyzed your appointment data. Here's what I found:</p>
                    </div>
                </div>
            `;

            // AI Insights message
            if (suggestions.length > 0) {
                messagesHtml += `
                    <div class="chat-message assistant">
                        <div class="chat-message-avatar">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M12 2a4 4 0 0 0-4 4c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2 4 4 0 0 0-4-4Z"/>
                                <path d="M10 8v8"/>
                                <path d="M14 8v8"/>
                                <path d="M8 16a4 4 0 0 0 8 0"/>
                                <path d="M12 16v6"/>
                            </svg>
                        </div>
                        <div class="chat-message-content">
                            <p style="margin: 0 0 12px 0; font-weight: 600; color: var(--primary-dark);">üí° AI-Powered Insights</p>
                            ${suggestions.map(s => `
                                <div style="margin-bottom: 12px; padding: 10px; background: rgba(5, 150, 105, 0.05); border-left: 3px solid var(--accent); border-radius: 6px;">
                                    <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 4px; display: flex; align-items: center; gap: 6px;">
                                        ${s.icon} ${formatMarkdown(s.title)}
                                    </div>
                                    <div style="color: var(--text-secondary); font-size: 0.9375rem; line-height: 1.6;">
                                        ${formatMarkdown(s.text)}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // Today's schedule message
            if (todayCount > 0) {
                messagesHtml += `
                    <div class="chat-message assistant">
                        <div class="chat-message-avatar">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                <line x1="16" y1="2" x2="16" y2="6"/>
                                <line x1="8" y1="2" x2="8" y2="6"/>
                                <line x1="3" y1="10" x2="21" y2="10"/>
                            </svg>
                        </div>
                        <div class="chat-message-content">
                            <p style="margin: 0 0 12px 0; font-weight: 600; color: var(--primary-dark);">üìÖ Today's Schedule</p>
                            ${data.today.slice(0, 5).map(apt => {
                                const patientName = getPatientName(apt.participant);
                                const appointmentType = getAppointmentType(apt);
                                const status = apt.status || '';
                                
                                return `
                                <div style="margin-bottom: 10px; padding: 10px; background: var(--surface-hover); border-radius: 8px; border: 1px solid var(--border-light);">
                                    <div style="font-size: 0.8125rem; color: var(--text-muted); margin-bottom: 4px;">
                                        ${formatAppointmentTime(apt.start)}
                                        ${status ? ` ‚Ä¢ <span style="text-transform: capitalize;">${status}</span>` : ''}
                                    </div>
                                    <div style="color: var(--text-primary); font-size: 0.9375rem;">
                                        <strong>${patientName}</strong>
                                        ${appointmentType !== 'General Visit' ? ` ‚Ä¢ ${appointmentType}` : ''}
                                    </div>
                                </div>
                                `;
                            }).join('')}
                            ${todayCount > 5 ? `<p style="text-align: center; color: var(--text-muted); font-size: 0.875rem; margin: 8px 0 0 0;">+${todayCount - 5} more appointments</p>` : ''}
                        </div>
                    </div>
                `;
            }

            contentEl.innerHTML = messagesHtml;
            contentEl.scrollTop = contentEl.scrollHeight;
        }

        // Parse AI suggestions into structured format
        function parseAISuggestions(text) {
            console.log('Parsing AI suggestions, input text:', text);
            const suggestions = [];
            const lines = text.split('\n').filter(line => line.trim());
            
            const icons = ['üéØ', 'üë§', '‚è∞', '‚ö†Ô∏è', 'üí°'];
            let iconIndex = 0;

            for (const line of lines) {
                // Look for numbered or bulleted items
                const match = line.match(/^[\d.)\-*‚Ä¢]\s*(.+?):\s*(.+)$/) || 
                             line.match(/^[\d.)\-*‚Ä¢]\s*(.+)$/);
                
                if (match) {
                    if (match[2]) {
                        suggestions.push({
                            icon: icons[iconIndex % icons.length],
                            title: match[1].trim(),
                            text: match[2].trim()
                        });
                    } else {
                        suggestions.push({
                            icon: icons[iconIndex % icons.length],
                            title: 'Recommendation',
                            text: match[1].trim()
                        });
                    }
                    iconIndex++;
                }
            }

            // If parsing failed, create a single suggestion with all text
            if (suggestions.length === 0) {
                console.log('No structured suggestions found, using raw text');
                suggestions.push({
                    icon: 'üí°',
                    title: 'AI Insights',
                    text: text.trim()
                });
            }

            console.log('Parsed suggestions:', suggestions);
            return suggestions.slice(0, 5); // Limit to 5 suggestions
        }

        // Format appointment time
        function formatAppointmentTime(dateString) {
            try {
                const date = new Date(dateString);
                return date.toLocaleTimeString('en-US', { 
                    hour: 'numeric', 
                    minute: '2-digit',
                    hour12: true 
                });
            } catch {
                return dateString;
            }
        }

        // Auto-resize chat textarea
        function autoResizeChat(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }

        // Handle keyboard events in chat input
        function handleChatKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                loadAppointmentInsights();
            }
        }

        // Get selected model
        function getSelectedModel() {
            return document.getElementById('model-select').value;
        }

        // Check if current model supports vision
        function isVisionModel() {
            const model = getSelectedModel();
            return model.toLowerCase().includes('vision') || 
                   model.toLowerCase().includes('llava') ||
                   model.toLowerCase().includes('qwen-vl');
        }

        // Update model (called when selection changes)
        function updateModel() {
            if (conversationHistory.length > 0) {
                conversationHistory = [];
            }
        }

        // Handle image file upload
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                processImageFile(file);
            }
        }

        // Handle paste event for screenshots
        function handlePaste(event) {
            const items = event.clipboardData?.items;
            if (items) {
                for (let item of items) {
                    if (item.type.startsWith('image/')) {
                        event.preventDefault();
                        const file = item.getAsFile();
                        processImageFile(file);
                        return;
                    }
                }
            }
        }

        // Process image file to base64
        function processImageFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                attachedImage = e.target.result;
                showImagePreview(attachedImage);
            };
            reader.readAsDataURL(file);
        }

        // Show image preview
        function showImagePreview(dataUrl) {
            const preview = document.getElementById('attached-image-preview');
            const img = document.getElementById('preview-img');
            img.src = dataUrl;
            preview.style.display = 'inline-block';
        }

        // Remove attached image
        function removeAttachedImage() {
            attachedImage = null;
            const preview = document.getElementById('attached-image-preview');
            preview.style.display = 'none';
            document.getElementById('image-upload').value = '';
        }

        // Capture screen prompt
        function captureScreen() {
            const status = document.getElementById('connection-status');
            status.textContent = 'üìã Take a screenshot (Ctrl+Shift+S or PrtSc), then paste here (Ctrl+V)';
            status.className = 'connection-status loading';
            document.getElementById('user-input').focus();
        }

        // Handle Enter key in API key input
        function handleApiKeyEnter(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                connectApiKey();
            }
        }

        // Connect with API key
        async function connectApiKey() {
            const input = document.getElementById('api-key-input');
            const btn = document.getElementById('connect-btn');
            const status = document.getElementById('connection-status');
            const key = input.value.trim();

            if (!key) {
                status.textContent = '‚ö†Ô∏è Please enter an API key';
                status.className = 'connection-status error';
                return;
            }

            if (!key.startsWith('hf_')) {
                status.textContent = '‚ö†Ô∏è Key should start with hf_';
                status.className = 'connection-status error';
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Connecting...';
            status.textContent = 'Testing connection...';
            status.className = 'connection-status loading';

            try {
                const response = await fetch('https://router.huggingface.co/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${key}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: getSelectedModel(),
                        messages: [{ role: 'user', content: 'Hi' }],
                        max_tokens: 5
                    })
                });

                if (response.ok) {
                    apiKey = key;
                    localStorage.setItem('hf_api_key', key);
                    status.textContent = '‚úì Connected successfully!';
                    status.className = 'connection-status success';
                    btn.textContent = 'Connected';
                    btn.className = 'connect-btn connected';
                    input.type = 'password';
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error?.message || `Error: ${response.status}`);
                }
            } catch (error) {
                status.textContent = `‚úó ${error.message}`;
                status.className = 'connection-status error';
                btn.textContent = 'Connect';
            } finally {
                btn.disabled = false;
            }
        }

        // Check for saved API key on load
        function checkSavedApiKey() {
            if (apiKey) {
                const input = document.getElementById('api-key-input');
                const btn = document.getElementById('connect-btn');
                const status = document.getElementById('connection-status');
                input.value = apiKey;
                btn.textContent = 'Connected';
                btn.className = 'connect-btn connected';
                status.textContent = '‚úì Using saved API key';
                status.className = 'connection-status success';
            }
        }

        // DOM Elements
        const chatMessages = document.getElementById('chat-messages');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');

        // Healthcare system prompt
        const systemPrompt = `You are a knowledgeable healthcare information assistant. Your role is to provide accurate, helpful health information while always emphasizing:

1. You provide general health information only, NOT medical diagnoses or treatment recommendations
2. Users should always consult qualified healthcare professionals for medical advice
3. In case of emergencies, users should call emergency services immediately

Be informative, compassionate, and clear in your responses. When discussing symptoms, mention when it would be appropriate to seek professional medical attention.`;

        // Send message
        async function sendMessage() {
            const message = userInput.value.trim();
            const hasImage = attachedImage !== null;
            
            if (!message && !hasImage) return;
            if (isProcessing) return;

            // Check if API key is set
            if (!apiKey) {
                const status = document.getElementById('connection-status');
                status.textContent = '‚ö†Ô∏è Please enter your API key and connect first';
                status.className = 'connection-status error';
                document.getElementById('api-key-input').focus();
                return;
            }

            // Remove welcome message if present
            const welcomeEl = chatMessages.querySelector('.welcome-message');
            if (welcomeEl) welcomeEl.remove();

            // Store current image before clearing
            const currentImage = attachedImage;
            
            // Add user message with image
            addMessage('user', message || 'Analyze this screen', currentImage);
            userInput.value = '';
            autoResize(userInput);
            removeAttachedImage();
            
            // Add typing indicator
            const typingId = addTypingIndicator();
            isProcessing = true;
            sendBtn.disabled = true;

            try {
                // Build the user content - with or without image
                let userContent;
                if (currentImage && isVisionModel()) {
                    // For vision models, send image with text
                    userContent = [
                        {
                            type: 'image_url',
                            image_url: {
                                url: currentImage
                            }
                        },
                        {
                            type: 'text',
                            text: message || 'Please analyze this screen/image and describe what you see. Focus on any healthcare-related information, patient data, or clinical context visible.'
                        }
                    ];
                } else if (currentImage) {
                    // Non-vision model but has image - add context
                    userContent = (message || '') + '\n\n[Note: An image was attached but the current model does not support vision. Please select Llama 3.2 Vision to analyze images.]';
                } else {
                    userContent = message;
                }

                const messages = [
                    { role: 'system', content: systemPrompt },
                    ...conversationHistory,
                    { role: 'user', content: userContent }
                ];

                const response = await fetch('https://router.huggingface.co/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: getSelectedModel(),
                        messages: messages,
                        max_tokens: 1024,
                        temperature: 0.3,
                        stream: false
                    })
                });

                removeTypingIndicator(typingId);

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error?.message || `API Error: ${response.status}`);
                }

                const data = await response.json();
                let assistantMessage = '';

                if (data.choices && data.choices[0]) {
                    assistantMessage = data.choices[0].message?.content || data.choices[0].text || '';
                }

                if (assistantMessage) {
                    // Store text-only version in history (images were already processed in this request)
                    const historyContent = message || 'Please analyze this screen/image and describe what you see.';
                    conversationHistory.push({ role: 'user', content: historyContent });
                    conversationHistory.push({ role: 'assistant', content: assistantMessage });
                    
                    if (conversationHistory.length > 20) {
                        conversationHistory = conversationHistory.slice(-20);
                    }

                    addMessage('assistant', assistantMessage);
                } else {
                    throw new Error('No response received from the API');
                }

            } catch (error) {
                removeTypingIndicator(typingId);
                addMessage('assistant', `‚ö†Ô∏è **Error:** ${error.message}\n\nPlease check your API key and try again.`);
            } finally {
                isProcessing = false;
                sendBtn.disabled = false;
            }
        }

        // Add message to chat
        function addMessage(role, content, imageData = null) {
            const messageEl = document.createElement('div');
            messageEl.className = `message ${role}`;
            
            const avatarIcon = role === 'assistant' 
                ? `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>`
                : `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`;

            const imageHtml = imageData ? `<img class="message-image" src="${imageData}" alt="Attached screenshot">` : '';
            const textHtml = content ? formatMessage(content) : '';

            messageEl.innerHTML = `
                <div class="message-avatar">${avatarIcon}</div>
                <div class="message-content">${imageHtml}${textHtml}</div>
            `;

            chatMessages.appendChild(messageEl);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Format message with basic markdown
        function formatMessage(text) {
            return text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/`(.*?)`/g, '<code>$1</code>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>')
                .replace(/^/, '<p>')
                .replace(/$/, '</p>');
        }

        // Add typing indicator
        function addTypingIndicator() {
            const id = 'typing-' + Date.now();
            const typingEl = document.createElement('div');
            typingEl.id = id;
            typingEl.className = 'message assistant';
            typingEl.innerHTML = `
                <div class="message-avatar">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
                </div>
                <div class="message-content">
                    <div class="typing-indicator">
                        <span></span><span></span><span></span>
                    </div>
                </div>
            `;
            chatMessages.appendChild(typingEl);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return id;
        }

        // Remove typing indicator
        function removeTypingIndicator(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        // Send quick prompt
        function sendQuickPrompt(prompt) {
            userInput.value = prompt;
            sendMessage();
        }

        // Clear chat
        function clearChat() {
            conversationHistory = [];
            chatMessages.innerHTML = `
                <div class="welcome-message">
                    <div class="welcome-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/>
                        </svg>
                    </div>
                    <h3 class="welcome-title">How can I help you today?</h3>
                    <p class="welcome-text">Ask me about symptoms, medications, wellness tips, or general health information.</p>
                    <div class="quick-prompts">
                        <button class="quick-prompt" onclick="sendQuickPrompt('What are common symptoms of seasonal allergies?')">
                            ü§ß Seasonal allergies
                        </button>
                        <button class="quick-prompt" onclick="sendQuickPrompt('What are the benefits of regular exercise?')">
                            üèÉ Exercise benefits
                        </button>
                        <button class="quick-prompt" onclick="sendQuickPrompt('How can I improve my sleep quality?')">
                            üò¥ Sleep quality tips
                        </button>
                        <button class="quick-prompt" onclick="sendQuickPrompt('What foods are good for heart health?')">
                            ‚ù§Ô∏è Heart-healthy foods
                        </button>
                    </div>
                </div>
            `;
        }

        // Handle keyboard events
        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // Auto-resize textarea
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 150) + 'px';
        }
    </script>
</body>
</html>
